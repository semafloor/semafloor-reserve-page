<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="full-view.html">
<link rel="import" href="list-view.html">

<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="../firebase-element/firebase-collection.html">

<link rel="import" href="../neon-animation/animations/slide-from-bottom-animation.html">
<link rel="import" href="../neon-animation/animations/slide-down-animation.html">
<!-- <link rel="import" href="../neon-animation/neon-animatable-behavior.html"> -->
<!-- <link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/hero-animation.html">
<link rel="import" href="../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html"> -->

<dom-module id="semafloor-reserve-page">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        user-select: none;

        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }

      * {
        box-sizing: border-box;
      }

      .reserve-page-container {
        position: relative;
        padding-bottom: 128px;
      }

      .full-list-view-page {
        background-color: #eee;
      }

      .loading {

      }

      .type-title-container {
        height: 64px;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      .type-title-bottomsheet {
        height: 64px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #212121;
        padding: 0 16px;
        opacity: 1;
        will-change: transform;
        /* Chrome's ease-out > out-sine */
        transition: opacity linear .2s, transform cubic-bezier(0.39, 0.58, 0.57, 1) .2s;

        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      .type-title-bottomsheet > .type-title {
        line-height: normal;
        font-weight: 500;
      }
      .each-type-and-count {
        padding-top: 8px;
        text-align: center;

        @apply(--layout-vertical);
      }

      .type-title {
        font-weight: 400;
        line-height: 26px;
        margin: 0 16px;
        text-transform: capitalize;
      }
      .type-title.today,
      .type-title.this-week,
      .type-title.upcoming {
        border-top: 1px solid #bdbdbd;
        color: #bdbdbd;
        transition: border-top ease-in .2s, color ease-in .2s;
      }
      .type-title.today.iron-selected {
        border-top: 2px solid #f44336;
        color: #f44336;
      }
      .type-title.this-week.iron-selected {
        border-top: 2px solid #2196F3;
        color: #2196F3;
      }
      .type-title.upcoming.iron-selected {
        border-top: 2px solid #4caf50;
        color: #4caf50;
      }

      .each-list-item {
        min-height: 64px;
        padding: 12px 16px;
        border-bottom: 1px solid #ddd;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .list-item-left-col {
        color: #455a64;
        text-transform: capitalize;
        text-align: right;
        font-size: 20px;
        margin-left: 12px;
        margin-right: auto;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
      }
      .list-item-left-col > span {
        font-size: 12px;
        color: #737373;
      }
      .list-item-right-col {
        color: #424242;
        font-size: 22px;
        margin-left: 8px;
        margin-right: 8px;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
      }


      paper-fab {
        position: fixed;
        bottom: calc(64px + 16px);
        right: 16px;
        border-radius: 50%;
        will-change: transform;
        /* Chrome's ease-out > out-sine */
        transition: opacity linear .2s,
                    transform cubic-bezier(0.39, 0.58, 0.57, 1) .2s,
                    background-color cubic-bezier(.39, .58, .57, 1) .2s;
        background-color: #1ddbd8;
      }
      paper-fab.today {
        background-color: #f44336;
      }
      paper-fab.this-week {
        background-color: #2196f3;
      }
      paper-fab.upcoming {
        background-color: #4caf50;
      }

      paper-dialog.list-view-detail-dialog {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      paper-dialog.list-view-detail-dialog > .fake-toolbar {
        background-color: #00796b;
        color: #f5f5f5;
        font-size: 20px;
        height: 64px;
        margin-top: 0;
        padding: 0 16px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .fake-toolbar > paper-icon-button {
        margin-right: 8px;
      }
      .fake-toolbar > paper-button {
        font-size: 14px;
        margin-left: auto;
        margin-right: 0;
      }
      .list-view-detail-container {
        height: calc(100% - 64px - 44px);
        @apply(--layout-scroll);
      }
      .each-detail {
        min-height: 48px;
        font-size: 16px;
        font-weight: 400;
        line-height: 24px;
        margin: 8px 0;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
      }
      .each-detail > span {
        min-height: 20px;
        font-size: 14px;
        font-weight: 400;
        line-height: 20px;
        color: #737373;
      }

      paper-toast {
        color: #1ddb8b;
      }
      paper-toast > ::content > span {
        margin-right: 12px;
      }
      paper-toast > span {
        cursor: pointer;

        color: #eeff41;
        text-transform: uppercase;
        margin-right: 0;
        font-style: italic;
      }
      paper-toast.undo-remove {
        color: #f5f5f5;
      }

      .empty-tab {
        color: #bdbdbd;
        font-size: 24px;
        font-weight: 700;
        padding: 16px;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }
      .empty-tab > iron-icon {
        margin: 24px 0;
        --iron-icon-width: 84px;
        --iron-icon-height: 84px;
        --iron-icon-fill-color: #bdbdbd;
      }

      /* @media for small desktop & tablet */
      @media all and (min-width: 600px) {
        .reserve-page-container {
          @apply(--layout-horizontal);
          @apply(--layout-center-justified);
          @apply(--layout-wrap);
        }

        .reserve-page-container {
          padding: 16px;
        }

        .each-list-item {
          min-width: 376px;
        }

        paper-dialog.list-view-detail-dialog {
          /*height: auto;*/
          height: 640px;
          width: 360px;
          margin: 20px 40px;
        }

        paper-fab {
          bottom: 24px;
          right: 24px;
        }
      }

    </style>

    <!-- <iron-media-query query="max-width: 400px" query-matches="{{_isSmallScreen}}"> -->
    <iron-media-query query="max-width: 599px" query-matches="{{_isSmallScreen}}">
    </iron-media-query>

    <firebase-collection id="reserveBase" location="[[_location]]" data="{{reservations}}" on-firebase-value="_onFirebaseValue"></firebase-collection>

    <!-- <div class$="reserve-page-container[[_computePageContainerCls(_isSmallScreen)]]"> -->
    <div class="reserve-page-container">
      <!-- <template is="dom-if" if="[[!_isSmallScreen]]" restamp="true" strip-whitespace>
        <iron-selector class="type-title-container" selected="{{_selectedPage}}" attr-for-selected="page">
          <template is="dom-repeat" items="[[_typeTitles]]" index-as="index">
            <div class$="type-title [[_computeTitleCls(index)]]" page="[[item]]">
              [[_computeTitleName(index)]]
            </div>
          </template>
        </iron-selector>
      </template> -->

      <template is="dom-if" if="[[_isSmallScreen]]" restamp="true" strip-whitespace>
        <iron-pages selected="[[_page]]" attr-for-selected="page">
          <div class="loading" page="loading"></div>

          <template is="dom-if" if="[[_isEmptyPageOpened]]" restamp="true" strip-whitespace>
            <div class="empty-tab" page="empty">
              <iron-icon icon="icons:done-all"></iron-icon>
              Reservation list is empty!
            </div>
          </template>

          <div id="listView" class="" page="list">
            <template id="list" is="dom-repeat" items="[[_list]]" index-as="index" strip-whitespace>
              <div class="each-list-item" on-tap="_showDetail">
                <!-- [[item]] -->
                <!-- [[index]] -->
                <div class="list-item-left-col">
                  [[item.roomInfo.room]]
                  <span>[[item.roomInfo.site]]</span>
                </div>

                <div class="list-item-right-col">
                  [[item.fromTime]] - [[item.toTime]]
                </div>
              </div>
            </template>
          </div>
        </iron-pages>
      </template>

      <template is="dom-if" if="[[!_isSmallScreen]]" restamp="true" strip-whitespace>
        <div class="today">
          <div class="type-title today iron-selected">
            <div class="each-type-and-count">
              <span> today </span>
              [[_todayCount]]
            </div>
          </div>

          <template id="todayList" is="dom-repeat" items="[[_todayList]]" index-as="index" strip-whitespace>
            <div class="each-list-item" on-tap="_showDetail">
              <!-- [[item]] -->
              <!-- [[index]] -->
              <div class="list-item-left-col">
                [[item.roomInfo.room]]
                <span>[[item.roomInfo.site]]</span>
              </div>

              <div class="list-item-right-col">
                [[item.fromTime]] - [[item.toTime]]
              </div>
            </div>
          </template>
        </div>

        <div class="thisweek">
          <div class="type-title this-week iron-selected">
            <div class="each-type-and-count">
              <span> this week </span>
              [[_thisweekCount]]
            </div>
          </div>

          <template id="thisweekList" is="dom-repeat" items="[[_thisweekList]]" index-as="index" strip-whitespace>
            <div class="each-list-item" on-tap="_showDetail">
              <!-- [[item]] -->
              <!-- [[index]] -->
              <div class="list-item-left-col">
                [[item.roomInfo.room]]
                <span>[[item.roomInfo.site]]</span>
              </div>

              <div class="list-item-right-col">
                [[item.fromTime]] - [[item.toTime]]
              </div>
            </div>
          </template>
        </div>

        <div class="upcoming">
          <div class="type-title upcoming iron-selected">
            <div class="each-type-and-count">
              <span> upcoming </span>
              [[_upcomingCount]]
            </div>
          </div>

          <template id="upcomingList" is="dom-repeat" items="[[_upcomingList]]" index-as="index" strip-whitespace>
            <div class="each-list-item" on-tap="_showDetail">
              <!-- [[item]] -->
              <!-- [[index]] -->
              <div class="list-item-left-col">
                [[item.roomInfo.room]]
                <span>[[item.roomInfo.site]]</span>
              </div>

              <div class="list-item-right-col">
                [[item.fromTime]] - [[item.toTime]]
              </div>
            </div>
          </template>
        </div>
      </template>
    </div>

    <paper-fab id="reserveFab" icon="icons:add" class$="[[_computeFabCls(_selectedPage, _isSmallScreen)]]" tab-index="0" on-tap="_reserveNew" on-transitionend="_reserveNew"></paper-fab>

    <template is="dom-if" if="[[_isSmallScreen]]" restamp="true" strip-whitespace>
      <iron-selector id="typeTitleBottomsheet" class="type-title-bottomsheet" selected="{{_selectedPage}}" attr-for-selected="page">
        <template is="dom-repeat" items="[[_typeTitles]]" index-as="index">
          <div class$="type-title [[_computeTitleCls(index)]]" page="[[item]]">
            <div class="each-type-and-count">
              <span> [[_computeTitleName(index)]] </span>
              [[_computeCount(index, _todayCount, _thisweekCount, _upcomingCount)]]
            </div>
          </div>
        </template>
      </iron-selector>
    </template>

    <iron-scroll-threshold id="scrollThreshold" scroll-target="[[scroller]]" on-lower-threshold="_loadMoreData"></iron-scroll-threshold>

    <template is="dom-if" if="[[_isListViewDetailOpened]]" restamp="true" strip-whitespace on-dom-change="_onDomChange">
      <paper-dialog id="listViewDetailDialog" class="list-view-detail-dialog" entry-animation="slide-from-bottom-animation" exit-animation="slide-down-animation" on-iron-overlay-closed="_manipulateDocumentScrolling" with-backdrop>
        <div class="fake-toolbar">
          <paper-icon-button icon="icons:arrow-back" on-tap="_closeDetail" on-transitionend="_closeDetail"></paper-icon-button>
          Reservation detail
          <paper-button on-tap="_removeItem" on-transitionend="_removeItem">remove</paper-button>
        </div>
        <div class="list-view-detail-container">
          <!--
          Title [[item.subject]]
          Reserved by [[item.person]]
          Requestor [[item.requestor]]
          Remarks [[item.remarks]]
          Reserved on [[item.reservedDate]]
          Room Reserved [[item.roomInfo.room]]
          Reservation date [[item.date]]
          Reservation time [[item.fromTime]] [[item.toTime]]
          -->
          <template is="dom-repeat" items="[[_listViewDetail]]" index-as="index" strip-whitespace>
            <div class="each-detail">
              Title
              <span>[[item.subject]]</span>
            </div>
            <div class="each-detail">
              Reserved by
              <span>[[item.person]]</span>
            </div>
            <div class="each-detail">
              Requestor
              <span>[[item.requestor]]</span>
            </div>
            <div class="each-detail">
              Remarks
              <span>[[item.remarks]]</span>
            </div>
            <div class="each-detail">
              Reserved on
              <span>[[item.reservedDate]]</span>
            </div>
            <div class="each-detail">
              Room reserved
              <span>[[item.roomInfo.site]], [[item.roomInfo.room]]</span>
            </div>
            <div class="each-detail">
              Reservation date
              <span>[[item.date]]</span>
            </div>
            <div class="each-detail">
              Reservation time
              <span>[[item.fromTime]] - [[item.toTime]]</span>
            </div>
          </template>
        </div>
      </paper-dialog>
    </template>

    <paper-toast id="reserveToast" text="[[_msg]]">
      <template is="dom-if" if="[[_showUndo]]" restamp="true" strip-whitespace>
        <span role="button" tabindex="0" on-tap="_undoItemRemoval">undo</span>
      </template>
    </paper-toast>
  </template>
  <script>
    Polymer({
      is: 'semafloor-reserve-page',

      properties: {
        uid: String,
        reservations: Object,
        postY: Number,

        _typeTitles: {
          type: Array,
          value: [ 'today', 'thisweek', 'upcoming' ]
        },
        _selectedPage: {
          type: String,
          value: 'today'
        },
        _page: String,
        _readyToReserve: Boolean,

        _todayList: Array,
        _thisweekList: Array,
        _upcomingList: Array,

        _todayView: Number,
        _thisweekView: Number,
        _upcomingView: Number,

        _todayCount: {
          type: Number,
          value: 0
        },
        _thisweekCount: {
          type: Number,
          value: 0
        },
        _upcomingCount: {
          type: Number,
          value: 0
        },

        _listViewDetail: Array,
        _readyToCloseDetail: Boolean,

        _location: String,

        _readyToRemoveItem: Boolean,
        _msg: String,
        _showUndo: Boolean,

        _mockList: Array,
      },

      observers: [
        '_updateFirebaseLocation(uid)',
        '_translateBottomsheet(postY)',
        '_lazifyList(_selectedPage, reservations.*)'
      ],

      ready: function() {
        // [[item.roomInfo.room]]
        // [[item.roomInfo.site]]
        // [[item.fromTime]]
        // [[item.toTime]]
        // [[item.subject]]
        //
        // Reserved by [[item.person]]
        // Requestor [[item.requestor]]
        // Remarks [[item.remarks]]
        // Reserved on [[item.reservedDate]]
        // Room Reserved [[item.roomInfo.room]]
        // Reservation date [[item.date]]
        // Reservation time [[item.fromTime]] [[item.toTime]]
        var _data = [];
        var _lorem = [
          'Lorem', 'ipsum', 'dolor', 'sit', 'amet', 'consectetur', 'adipisicing', 'elit',
          'sed', 'do', 'eiusmod', 'tempor', 'incididunt', 'ut labore',  'et dolore magna',
          'aliqua.', 'Ut enim ad minim veniam', 'quis nostrud', 'exercitation ullamco laboris',
          'nisi ut', 'aliquip ex ea', 'commodo consequat.', 'Duis aute irure', 'dolor in',
          'reprehenderit in', 'voluptate velit', 'esse cillum', 'dolore eu fugiat nulla pariatur.',
          'Excepteur sint', 'occaecat cupidatat', 'non proident', 'sunt in', 'culpa qui officia',
          'deserunt mollit', 'anim id est laborum.', '', '', '', '', '', '', '', '', '', '', ''
        ];
        var _loremLen = _lorem.length;

        for (var i = 0; i < 999; i++) {
          _data[i] = {
            roomInfo: {
              room: _lorem[Math.ceil(Math.random() * _loremLen)],
              site: _lorem[Math.ceil(Math.random() * _loremLen)]
            },
            fromTime: _lorem[Math.ceil(Math.random() * _loremLen)],
            toTime: _lorem[Math.ceil(Math.random() * _loremLen)],
            subject: _lorem[Math.ceil(Math.random() * _loremLen)],
            person: _lorem[Math.ceil(Math.random() * _loremLen)],
            requestor: _lorem[Math.ceil(Math.random() * _loremLen)],
            remarks: _lorem[Math.ceil(Math.random() * _loremLen)],
            reservedDate: _lorem[Math.ceil(Math.random() * _loremLen)],
            date: _lorem[Math.ceil(Math.random() * _loremLen)]
          };
        }
        _data = _data.slice();

        // this.set('reservations.all', _data.splice(0, 20));
        // this.set('reservations', {});
        // this.set('_mockList', _data);

        // TODO: testing purpose...
        // var _todayList = _data.splice(0, Math.random() * 155);
        // var _thisweekList = _data.splice(0, Math.random() * 15);
        // var _upcomingList = _data.splice(0, Math.random() * 15);
        //
        // this.set('reservations.today', _todayList);
        // this.set('reservations.thisweek', _thisweekList);
        // this.set('reservations.upcoming', _upcomingList);
        // this.set('_todayCount', _todayList.length);
        // this.set('_thisweekCount', _thisweekList.length);
        // this.set('_upcomingCount', _upcomingList.length);
      },

      attached: function() {
        this.set('scroller', Polymer.dom(this.ownerDocument).querySelector('html'));

        console.log('reserve-page-attached');
        this.fire('reserve-page-attached');
      },

      _computeTitleCls: function(_typeTitleIdx) {
        var _cls = ['today', 'this-week', 'upcoming'];
        return _cls[_typeTitleIdx];
      },
      _computeFabCls: function(_selectedPage, _isSmallScreen) {
        if (!_isSmallScreen) {
          return '';
        }

        var _idx = ['today', 'thisweek', 'upcoming'].indexOf(_selectedPage);
        var _cls = ['today', 'this-week', 'upcoming'];
        return _cls[_idx];
      },
      // _computePageContainerCls: function(_isSmallScreen) {
      //   return _isSmallScreen ? '' : ' horizontal';
      // },
      _computeTitleName: function(_idx) {
        return ['today', 'this week', 'upcoming'][_idx];
      },
      _computeCount: function(_idx) {
        var _listIdx = ['today', 'thisweek', 'upcoming'][_idx];
        var _listName = '_' + _listIdx + 'Count';
        return this[_listName];
      },

      _loadMoreData: function() {
        if (typeof this.reservations[this._selectedPage] === 'undefined') {
          return;
        }

        var _selectedPage = this._selectedPage;
        var _data = this.reservations[_selectedPage];
        var _view = '_' + _selectedPage + 'View';
        var _viewCount = this[_view] || 0;
        var _dataCount = this['_' + _selectedPage + 'Count'];
        // console.log(_view, _viewCount, _dataCount);
        // No need to load more data when everything has been loaded into the
        // items of the dom-repeat. _viewCount has reached or exceeded total
        // count of the selected type/ page (eg. _todayCount).
        if (_viewCount >= _dataCount) {
          // Always clearTriggers() before leaving this method.
          this.$.scrollThreshold.clearTriggers();
          return;
        }

        var _nextSlice = _data.slice(_viewCount, _viewCount + 5);
        var _nextSliceLen  = _nextSlice.length;

        for (var i = 0; i < _nextSliceLen; i++) {
          // this.push('reservations.' + _selectedPage, _nextSlice[i]);
          this.$$('#list').push('items', _nextSlice[i]);
        }
        this.set(_view, _viewCount + 5);
        this.$.scrollThreshold.clearTriggers();
      },
      _translateBottomsheet: function(_postY) {
        // SUprisingly this doesn't trigger much painting as I'd have expected.
        // Maybe due to something else is triggerting reflow, repaint and composite,
        // so this becomes part of it?
        var _bottomSheet = this.$$('#typeTitleBottomsheet');
        var _fab = this.$.reserveFab;
        if (_bottomSheet) {
          _fab.style.opacity = Math.max(0, 1 - _postY / 350);
          _bottomSheet.style.opacity = Math.max(0, 1 - _postY / 350);
          // Huh?! this.transform won't work but this works?
          this.translate3d('0', _postY + 'px', '0', _bottomSheet);
          this.translate3d('0', (_postY * 2)+ 'px', '0', _fab);
        }
      },
      _reserveNew: function(ev) {
        this.debounce('debounceTransitionend', function() {
          if (ev.type === 'tap') {
            this.set('_readyToReserve', !0);
          }else {
            if (this._readyToReserve) {
              var _parentNode = this.domHost;
              this.set('_readyToReserve', !1);
              _parentNode.animateReservePage();
            }
          }
        }, 1);
      },
      _lazifyList: function(_selectedPage, _reservations) {
        // console.log('_lazifyList', _selectedPage, _reservations.path, typeof _reservations.base[_selectedPage] == 'undefined');
        // Since _reservations is of type Object, the observer will run once
        // this is initialized with an {}. However, we only want this method
        // to run only when has it some items (eg. Array) inside.
        if (typeof _reservations.base[_selectedPage] === 'undefined') {
          return;
        }

        var _view = '_' + _selectedPage + 'View';
        // Switch empty page when the list is empty.
        if (_.isEmpty(_reservations.base[_selectedPage])) {
          console.log('_lazifyList > _isEmpty:', _selectedPage);
          if (!this._isEmptyPageOpened) {
            this.set('_isEmptyPageOpened', !0);
          }
          this.set(_view, 0);
          this.set('_list', []);
          this.set('_page', 'empty');
          return;
        }

        // var _pageList = '_' + _selectedPage + 'List';
        var _viewCount = this[_view] || 10;
        // console.log('_lazifyList', _pageList, _view, _viewCount, _reservations, this['reservations']['today']);
        var _slice = _reservations.base[_selectedPage].slice(0, _viewCount);
        this.set(_view, _viewCount);
        // Assign sliced list into the dom-repeat.
        this.set('_list', _slice);
        // Then change iron-page to reveal the list data at 'list' page.
        this.set('_page', 'list');
      },

      _showDetail: function(ev) {
        // console.log(ev, ev.model.item);
        var _selectedItem = ev.model.item;
        var _isListViewDetailOpened = this._isListViewDetailOpened;

        this.set('_listViewDetail', [_selectedItem]);
        this._manipulateDocumentScrolling('hidden');
        if (_isListViewDetailOpened) {
          this.async(function() {
            this.$$('#listViewDetailDialog').open();
          }, 1);
        }else {
          this.set('_isListViewDetailOpened', !0);
        }
      },
      _onDomChange: function(ev) {
        // console.log(ev);
        if (ev.target.if) {
          this.async(function() {
            this.$$('#listViewDetailDialog').open();
          }, 1);
        }
      },
      _closeDetail: function(ev) {
        this.debounce('_closeDetail', function() {
          if (ev.type === 'tap') {
            this.set('_readyToCloseDetail', !0);
          }else {
            if (this._readyToCloseDetail) {
              this.set('_readyToCloseDetail', !1);
              this.$$('#listViewDetailDialog').close();
            }
          }
        }, 1);
      },
      _removeItem: function(ev) {
        this.debounce('_removeItem', function() {
          var _type = ev.type === 'tap';
          if (_type) {
            this.set('_readyToRemoveItem', !0);
          }else {
            if (this._readyToRemoveItem) {
              this.set('_readyToRemoveItem', !1);
              // Close dialog first.
              this.$$('#listViewDetailDialog').close();

              var _reserveBaseRef = new Firebase(this._location);
              // As the detail itself is an Object, in order to be able to iterate thru
              // by dom-repeat, wrapped it inside Array. Hence, [0] is always the value.
              var _itemToRemove = this._listViewDetail[0];
              var _thisOpenReserveToast = this._openReserveToast.bind(this);
              // console.log('_removeItem', _reserveBaseRef, _itemToRemove[0]);
              // If accessed user's database successfully...
              _reserveBaseRef.once('value', function(snapshot) {
                var _refToRemove = '';
                snapshot.forEach(function(n) {
                  // Check if selected item object is equal to traversed object from Firebase.
                  if (_.isEqual(n.val(), _itemToRemove)) {
                    // Save the reference URL.
                    _refToRemove = n.ref();
                    // Then break the forEach loop.
                    return !0;
                  }
                });
                // If ref to remove an item exists...
                if (!!_refToRemove) {
                  _refToRemove.transaction(function(data) {
                    if (data === null) {
                      return;
                    }else {
                      // Return null to remove object.
                      return null;
                    }
                  }).then(function(val) {
                    if (!val.committed) {
                      console.warn('Data not found!');
                    }
                    // console.log(val.committed, val.snapshot);
                  }).catch(function(error) {
                    console.error(error);
                  });
                  _thisOpenReserveToast('The selected item has been removed.', !0);
                }
              }).catch(function(error) {
                console.error(error);
              });
            }
          }
        }, 1);
      },
      _openReserveToast: function(_msg, _showUndo) {
        var _reserveToast = this.$.reserveToast;
        if (_reserveToast.opened) {
          _reserveToast.close();
        }
        this.toggleClass('undo-remove', _showUndo, _reserveToast);
        this.set('_showUndo', _showUndo);
        this.set('_msg', _msg);
        this.async(function() {
          _reserveToast.open();
        }, 1);
      },
      _undoItemRemoval: function(ev) {
        var _reserveBaseRef = new Firebase(this._location);
        var _selectedItemToRestore = this._listViewDetail[0];
        var _thisOpenReserveToast = this._openReserveToast.bind(this);
        // If accessed user's database successfully...
        _reserveBaseRef.once('value', function(snapshot) {
          // Undo deleted item by Firebase.push method.
          _reserveBaseRef.push(_selectedItemToRestore).catch(function(error) {
            console.error(error);
          });
          _thisOpenReserveToast('Removed item has been recovered!', !1);
        }).catch(function(error) {
          console.error(error);
        });
      },

      _updateFirebaseLocation: function(_uid) {
        this.set('_location',
         '//semafloor-webapp.firebaseio.com/users/google/' + _uid + '/reservations');
      },
      _onFirebaseValue: function(ev) {
        var _val = ev.detail.val();
        if (!_val) {
          return;
        }

        var _sortedVal = this._sortVal(_val);
        var _todayCount = _sortedVal['today'].length;
        var _thisweekCount = _sortedVal['thisweek'].length;
        var _upcomingCount = _sortedVal['upcoming'].length;
        this.set('_todayCount', _todayCount);
        this.set('_thisweekCount', _thisweekCount);
        this.set('_upcomingCount', _upcomingCount);

        // If _isSmallScreen is true, set _sortedVal to 'reservations'.
        // Otherwise, separately set to corresponding list.
        if (this._isSmallScreen) {
          this.set('reservations', _sortedVal);
        }else {
          this.set('_todayList', _sortedVal.today);
          this.set('_thisweekList', _sortedVal.thisweek);
          this.set('_upcomingList', _sortedVal.upcoming);
        }

        this.fire('reserve-page-firebase-ready');
        console.log('_onFirebaseValue');
      },
      _sortVal: function(_val) {
        // Sort Firebase value by both 'date' and 'period' ascendingly.
        // After sorting, _val will be coerced into type Array from type Object .
        var _sorted = _.orderBy(_val, ['date', 'period'], ['asc', 'asc']);
        // var _now = new Date();
        // TODO: Testing purpose...
        // Note: new Date('2016-1-1 00:00') !== new Date('2016-01-01T00:00')
        // But: new Date('2016-1-1 00:00').getTime === new Date('2016-01-01 00:00').getTime()
        var _now = new Date('2016-02-16 00:00');
        var _nowTime = _now.getTime();
        var _nowDay = _now.getDay();
        var _ff = _now.getFullYear();
        var _mm = _now.getMonth() + 1;
        var _dd = _now.getDate();
        var _maxDd = _dd - _nowDay + 6; // By deducting the day number then add 6 will offset to Sat.
        var _fd = _ff + '-' + _mm + '-' + _maxDd + ' 00:00';
        var _maxNow = new Date(_fd).getTime();
        var _computedDate;
        var _todayFiltered = [];
        var _thisweekFiltered = [];
        var _upcomingFiltered = [];
        var _sortedLen = _sorted.length;
        // Filter all data into 3 different types: today, thisweek, and upcoming.
        for (var i = 0; i < _sortedLen; i++) {
          _computedDate = new Date(_sorted[i].date + ' 00:00').getTime();
          if (_computedDate === _nowTime) {
            // console.log('===: ', _maxNow, _sorted[i].date);
            _todayFiltered.push(_sorted[i]);
          }else if (_computedDate > _maxNow) {
            // console.log('>: ', _maxNow, _sorted[i].date);
            _upcomingFiltered.push(_sorted[i]);
          }else {
            // console.log('><: ', _maxNow, _sorted[i].date);
            _thisweekFiltered.push(_sorted[i]);
          }
        }
        // Return everything filtered wrapped inside an Object.
        return {
          'today': _todayFiltered,
          'thisweek': _thisweekFiltered,
          'upcoming': _upcomingFiltered
        };
      },

      _manipulateDocumentScrolling: function(_state) {
        var _overflow = typeof _state == 'object' ? '' : _state || '';
        document.body.style.overflow = _overflow;
      },
      // TODO: Polish _lazifyList & _loadMoreData as it works as expected before this.
      // TODO: Cleanup ALL mock data when finished developing.

    });
  </script>
</dom-module>
