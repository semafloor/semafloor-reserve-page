<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="reserve-list-theme.html">

<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="../paper-ripple/paper-ripple.html">

<dom-module id="reserve-list">
  <template>
    <style include="reserve-list-theme"></style>

    <iron-ajax id="listAjax"
      auto
      url="../json/[[name]]-booking.json"
      handle-as="json"
      on-response="_onResponse"
      last-response="{{_reservations}}"></iron-ajax>

    <!-- <div class="list-container"> -->
      <iron-list id="reserveList" items="[[_reservations]]">
        <template>
          <div class="reserve-item" aria-expanded$="[[_isExpanded(index)]]" aria-controls$="[[_isCollapsible(index)]]" on-tap="_toggle">
            <!-- <span>[[index]]</span> -->
            <div class="item-container">
              <div class="item-left">
                <div class="item-room">[[item.room]]</div>
                <div class="item-site">[[item.site]]</div>
              </div>

              <div class="item-right">
                <div class="item-period">[[item.period]]</div>
                <div class="item-subject">[[item.subject]]</div>
              </div>
            </div>

            <!-- <paper-ripple></paper-ripple> -->
            <div id$="[[_isCollapsible(index)]]" class="collapsible-items">
              <template is="dom-repeat" items="[[item.details]]" index-as="index" as="detail">
                <div class="collapsible-item">
                  <span>[[detail.label]]</span>
                  <span>[[detail.data]]</span>
                </div>
              </template>
            </div>
          </div>
        </template>
      </iron-list>
    <!-- </div> -->
  </template>
  <script>
    Polymer({
      is: 'reserve-list',

      properties: {
        name: String,
        count: {
          type: Number,
          notify: true
        },

        _reservations: {
          type: Object,
          value: function () {
            return [];
          }
        },

      },

      attached: function() {
        this.fire('list-ready', {readyList: this.name});
      },

      // observers: [
      //   '_logResponse(_reservations)',
      //   '_logName(name)'
      // ],

      // _logResponse: function (_response) {
      //   console.log(_response);
      // },
      //
      // _logName: function (_name) {
      //   console.log(_name);
      // },

      _onResponse: function (ev) {
        // count the list when the data is successfully received.
        this._countList(this._reservations);
      },

      _countList: function (_json) {
        var _count = _.size(_json);
        this.set('count', _count);
      },

      updateList: function () {
        console.log('update-list');
        this.$.reserveList.fire('iron-resize');
      },

      _isExpanded: function (_idx) {
        return 'opened' + _idx;
      },

      _isCollapsible: function (_idx) {
        return 'collapse' + _idx;
      },

      _toggle: function (ev) {
        // console.log(ev);
        var _target = ev.target;
        if (_target && _target.hasAttribute('aria-controls')) {
          _target = this.$$('#' + _target.getAttribute('aria-controls'));
          var _isOpened = _target.classList.contains('opened');
          if (_target) {
            if (_isOpened) {
              _target.classList.remove('opened');
            }else {
              _target.classList.add('opened');
            }
            this.$.reserveList.updateSizeForItem(ev.model.index);
          }
        }
      },

      updateListStyle: function (_width) {
        console.log('update-list-style');
        // calculate number of columns best fit the screen.
        var _itemWidth = '50%';
        if (_width > 360 && _width <=  600) {
          _itemWidth = '33%'; // tablet
        }else if (_width > 600) {
          _itemWidth = '25%'; // desktop
        }
        console.log(_itemWidth);
        // update number of column for collapsible item.
        this.updateStyles({
          '--collapsible-item-width': _itemWidth
        });
      },

    });
  </script>
</dom-module>
