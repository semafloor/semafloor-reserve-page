<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="reserve-list-theme.html">

<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-icon-item.html">

<link rel="import" href="../neon-animation/animations/transform-animation.html">

<dom-module id="reserve-list">
  <template strip-whitespace>
    <style include="reserve-list-theme"></style>

    <iron-ajax id="listAjax"
      auto
      url="../json/[[name]]-booking.json"
      handle-as="json"
      on-response="_onResponse"
      last-response="{{_reservations}}"></iron-ajax>

    <!-- <div class="list-container"> -->
      <iron-list id="reserveList" items="[[_reservations]]">
        <template>
          <div class="reserve-item" aria-expanded$="[[_isExpanded(index)]]" aria-controls$="[[_isCollapsible(index)]]" on-tap="_toggle">
            <!-- <span>[[index]]</span> -->
            <div class="item-container">
              <div class="item-left">
                <div class="item-room">[[item.room]]</div>
                <div class="item-site">[[item.site]]</div>
              </div>

              <div class="item-right">
                <div class="item-period">[[item.period]]</div>
                <div class="item-subject">[[item.subject]]</div>
              </div>

              <paper-icon-button icon="icons:more-vert" class="more-options" on-tap="_optionsMenu"></paper-icon-button>
            </div>

            <div id$="[[_isCollapsible(index)]]" class="collapsible-items">
              <template is="dom-repeat" items="[[item.details]]" index-as="index" as="detail">
                <div class="collapsible-item">
                  <span>[[detail.label]]</span>
                  <span>[[_isObject(detail.data)]]</span>
                </div>
              </template>
            </div>
          </div>
        </template>
      </iron-list>

      <div class="">
        <paper-dialog id="optionsDialog" with-backdrop>
          <paper-menu selected="0">
            <paper-icon-item dialog-confirm on-tap="_removeItem">
              <iron-icon icon="icons:remove-circle" item-icon></iron-icon>Remove
            </paper-icon-item>
            <paper-icon-item dialog-dismiss>
              <iron-icon icon="icons:close" item-icon></iron-icon>Close
            </paper-icon-item>
          </paper-menu>
        </paper-dialog>
      </div>
    <!-- </div> -->
  </template>
  <script>
    Polymer({
      is: 'reserve-list',

      properties: {
        name: String,
        count: {
          type: Number,
          notify: true
        },

        _reservations: {
          type: Object,
          value: function () {
            return [];
          }
        },
        _selectedIdx: Number,
        _selectedItem: Object,

      },

      attached: function() {
        this.fire('list-ready', {readyList: this.name});

        var _dialog = this.$.optionsDialog;
        _dialog.animationConfig = {
          'entry': {
            name: 'transform-animation',
            node: _dialog,
            transformFrom: 'translateY(100%)',
            transformTo: 'translateY(0)'
          },
          'exit': {
            name: 'transform-animation',
            node: _dialog,
            transformFrom: 'translateY(0)',
            transformTo: 'translateY(100%)'
          }
        };
      },

      // observers: [
      //   '_logResponse(_reservations)',
      //   '_logName(name)'
      // ],

      // _logResponse: function (_response) {
      //   console.log(_response);
      // },
      //
      // _logName: function (_name) {
      //   console.log(_name);
      // },

      _onResponse: function (ev) {
        // count the list when the data is successfully received.
        this._countList(this._reservations);
      },

      _countList: function (_json) {
        var _count = _.size(_json);
        this.set('count', _count);
      },

      updateList: function () {
        this.$.reserveList.fire('iron-resize');
      },

      _isExpanded: function (_idx) {
        return 'opened' + _idx;
      },

      _isCollapsible: function (_idx) {
        return 'collapse' + _idx;
      },

      _toggle: function (ev) {
        var _target = ev.target;

        if (_target.tagName === 'IRON-ICON') {
          return;
        }

        _target = _target.parentElement;

        if (_target && _target.hasAttribute('aria-controls')) {
          _target = this.$$('#' + _target.getAttribute('aria-controls'));
          var _isOpened = _target.classList.contains('opened');
          if (_target) {
            if (_isOpened) {
              _target.classList.remove('opened');
            }else {
              _target.classList.add('opened');
            }
            this.$.reserveList.updateSizeForItem(ev.model.index);
          }
        }
      },

      updateListStyle: function (_width) {
        // calculate number of columns best fit the screen.
        var _itemWidth = '50%';
        if (_width > 360 && _width <=  600) {
          _itemWidth = '33%'; // tablet
        }else if (_width > 600) {
          _itemWidth = '25%'; // desktop
        }
        // update number of column for collapsible item.
        this.updateStyles({
          '--collapsible-item-width': _itemWidth
        });
      },

      _isObject: function (_data) {
        var _result = _data;
        if (_.isObject(_data)) {
          _result = _data.tStart + ' - ' + _data.tEnd;
        }
        return _result;
      },

      _optionsMenu: function (ev) {
        var _target = ev.target;

        while (_target && _target.tagName !== 'PAPER-ICON-BUTTON') {
          _target = _target.parentElement;
        }

        this.set('_selectedIdx', ev.model.index);
        this.set('_selectedItem', ev.model.item);
        this.$.optionsDialog.open();
      },

      // simple removing item from list for Firebase.
      _removeItem: function (ev) {
        // console.log(this._reservations);
        // console.log(this._selectedIdx);
        // console.log(this._selectedItem);

        // var $array = this._reservations;
        // var $idx = this._selectedIdx;
        // var $remove = _.remove($array, function (el, idx, arr) {
        //   return idx === $idx;
        // });
        // console.log($remove);
        // console.log($array);
        // console.log(this._reservations);
      },

    });
  </script>
</dom-module>
